#!/bin/sh

# https://devcenter.heroku.com/articles/buildpack-api#bin-compile
#
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3


if [ "$BUILDINFO_FILE" != "" ]; then
  BUILDINFO_FILE="$BUILDINFO_FILE"
else
  # use leading dot to hide it
  BUILDINFO_FILE=".build-info.json"
fi

if [ "$BUILDINFO_DIR" != "" ]; then
  BUILDINFO_DIR=$BUILD_DIR/$BUILDINFO_DIR
else
  # default to root dir
  BUILDINFO_DIR=$BUILD_DIR
fi

BUILDINFO_PATH="$BUILDINFO_DIR/$BUILDINFO_FILE"

# lifted from heroku docs
export_env_dir() {
  env_dir=$3
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

export_env_dir


echo "=====> Writing out build info to ${BUILDINFO_PATH}"
echo "{ \
\"sha\" : \"${SOURCE_VERSION}\",\
\"repo_url\" : \"${REPO_URL}/commits/${SOURCE_VERSION}\"\
}" > ${BUILDINFO_PATH}
